<?xml version="1.0" encoding="UTF-8"?>
<hdevelop file_version="1.1" halcon_version="13.0">
<procedure name="main">
<interface/>
<body>
<c>* This program demonstrates how to detect small texture</c>
<c>* defects on the surface of carbon fiber rovings using</c>
<c>* canny edge detection.</c>
<c>*</c>
<c>* Initializations</c>
<l>dev_update_off ()</l>
<l>dev_close_window ()</l>
<c>*</c>
<c>* Write Image to file?</c>
<c>* 0 = Dont write to file</c>
<c>* 1 = Write to file</c>
<l>WriteImageToFile := 0</l>
<c>* Alternative Image Paths</c>
<c>* Uncomment and edit path if necessary</c>
<l>*OutPath := 'C:/Users/Public/Documents/'</l>
<l>path := ''</l>
<c>* Image Acquisition 01: Code generated by Image Acquisition 01</c>
<l>try    </l>
<l>list_files (path, ['files','follow_links'], ImageFiles)</l>
<l>tuple_regexp_select (ImageFiles, ['\\.(tif|tiff|gif|bmp|jpg|jpeg|jp2|png|pcx|pgm|ppm|pbm|xwd|ima|hobj)$','ignore_case'], ImageFiles)</l>
<c>* </c>
<c>* Start loop for iterating through image list</c>
<l>for Index := 0 to |ImageFiles| - 1 by 1</l>
<l>    read_image (Image, ImageFiles[Index])    </l>
<l>    get_image_size (Image, Width, Height)</l>
<c>    *</c>
<c>    * Calculate scale factor    </c>
<l>    if (Height &gt;= 1000)</l>
<l>        Width := Width * 1000/Height</l>
<l>        Height := 1000</l>
<l>    endif</l>
<l>    Width := Width * 0.9</l>
<l>    Height := Height * 0.9</l>
<c>    *</c>
<c>    * Open Window and show original Image</c>
<l>    dev_set_draw ('margin')</l>
<l>    dev_set_line_width (3)</l>
<l>    dev_set_color ('red')</l>
<l>    dev_display (Image)</l>
<l>    ResultMessage := ['Original View']</l>
<c>    * </c>
<c>    * Process the images iteratively    </c>
<l>    rgb1_to_gray (Image, ImageResult)</l>
<c>    * </c>
<c>    * Process the filtered image</c>
<l>    min_max_gray (Image, ImageResult, 0, Min, Max, Range)</l>
<c>    * ============== FOR Nonwoven Fabrics - TWISTS ===================</c>
<l>    threshold (ImageResult, ThreshRegion, 0, 73)</l>
<l>    write_object(ThreshRegion, 'threshold')</l>
<c>    * ============== END ===================</c>
<c>    *</c>
<c>    * Create Regions to mark defects</c>
<l>    connection (ThreshRegion, ConnectedRegions)  </l>
<l>    write_object(ConnectedRegions, 'connection1')</l>
<l>    *connection (ConnectedRegions1, ConnectedRegions)    </l>
<c>    * ============== FOR FOR Nonwoven Fabrics ===================</c>
<l>    select_shape (ConnectedRegions, SelectedRegions, 'area', 'and', 500, 999999)  </l>
<l>    write_object(SelectedRegions, 'selectShape1')</l>
<c>    * ============== FOR FOR Nonwoven Fabrics ===============</c>
<l>    union1 (SelectedRegions, RegionUnion)</l>
<l>    write_object(RegionUnion, 'union11')</l>
<l>    gen_circle(Circle,100.0,100.0,8)</l>
<l>    gen_rectangle1(Rectangle, 1, 1, 20, 5)</l>
<l>    closing(RegionUnion,Circle, RegionUnion2)</l>
<l>    write_object(RegionUnion2, 'closing1')</l>
<l>    closing(RegionUnion2,Rectangle, RegionClosing)</l>
<l>    write_object(RegionClosing, 'closing2')</l>
<l>    connection (RegionClosing, ConnectedRegions2)</l>
<l>    write_object(ConnectedRegions2, 'connection2')</l>
<l>    select_shape (ConnectedRegions2, SelectedRegions1, 'area', 'and',800, 999999)    </l>
<l>    write_object(SelectedRegions1, 'selectShape2')</l>
<l>    area_center (SelectedRegions1, Area, Row, Column)</l>
<c>    * Display the results</c>
<c>    * Open a another window and show segmented image</c>
<l>    dev_open_window (10, 100, Width, Height, 'black', WindowHandle3)    </l>
<l>    dev_set_draw ('margin')</l>
<l>    dev_set_line_width (2)</l>
<l>    dev_set_color ('red')</l>
<l>    set_display_font (WindowHandle3, 14, 'mono', 'true', 'false')</l>
<l>    Number := |Area|</l>
<l>    if (Number)</l>
<l>        ResultMessage := ['No ' + Index  + ' - Not OK',Number + ' defect(s) found']</l>
<l>        Color := ['red','black']</l>
<l>    else</l>
<l>        ResultMessage := 'No ' + Index  + ' - OK'</l>
<l>        Color := 'forest green'</l>
<l>    endif</l>
<l>    dev_display(Image)</l>
<l>    dev_display (SelectedRegions1)</l>
<l>    disp_message (WindowHandle3, ResultMessage, 'window', 12, 12, Color, 'true')</l>
<l>    disp_continue_message (WindowHandle3, 'red', 'true')</l>
<l>    stop ()        </l>
<c>    *</c>
<c>    * Write Image to file</c>
<l>    if (WriteImageToFile)</l>
<l>        FileName := OutPath + 'Img' + Index</l>
<l>        paint_region(SelectedRegions,Image,OutImage,255,'margin')</l>
<l>        write_image(OutImage, 'tiff jpeg 90', 0, FileName)</l>
<l>    endif</l>
<l>    dev_close_window()</l>
<l>    dev_close_window()</l>
<l>    dev_close_window()</l>
<l>    dev_close_window()</l>
<l>    dev_close_window()</l>
<c>    *</c>
<c>    * Wait for next step</c>
<l>endfor</l>
<l>catch (Exception)</l>
<l>    throw ([Exception,'unknown exception in myproc'])</l>
<l>endtry</l>
<c>* Stop HDevelop Script</c>
<l>stop()</l>
</body>
<docu id="main">
<parameters/>
</docu>
</procedure>
<procedure name="open_zoom_window">
<interface>
<ic>
<par name="RowPos" base_type="ctrl" dimension="0"/>
<par name="ColPos" base_type="ctrl" dimension="0"/>
<par name="RowROI1" base_type="ctrl" dimension="0"/>
<par name="ColROI1" base_type="ctrl" dimension="0"/>
<par name="RowROI2" base_type="ctrl" dimension="0"/>
<par name="ColROI2" base_type="ctrl" dimension="0"/>
<par name="ZoomFactor" base_type="ctrl" dimension="0"/>
</ic>
<oc>
<par name="WindowHandleZoom" base_type="ctrl" dimension="0"/>
</oc>
</interface>
<body>
<l>dev_open_window (RowPos, ColPos, (ColROI2 - ColROI1) * ZoomFactor, (RowROI2 - RowROI1) * ZoomFactor, 'black', WindowHandleZoom)</l>
<l>dev_set_part (round(RowROI1), round(ColROI1), round(RowROI2), round(ColROI2))</l>
<l>return ()</l>
</body>
<docu id="open_zoom_window">
<short lang="de_DE">open window and set part</short>
<short lang="en_US">open window and set part</short>
<parameters>
<parameter id="ColPos"/>
<parameter id="ColROI1"/>
<parameter id="ColROI2"/>
<parameter id="RowPos"/>
<parameter id="RowROI1"/>
<parameter id="RowROI2"/>
<parameter id="WindowHandleZoom"/>
<parameter id="ZoomFactor"/>
</parameters>
</docu>
</procedure>
</hdevelop>
